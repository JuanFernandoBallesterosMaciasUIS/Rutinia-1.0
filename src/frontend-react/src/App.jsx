import { useState, useEffect } from 'react';
import Sidebar from './components/Sidebar';
import Footer from './components/Footer';
import HabitCard from './components/HabitCard';
import NewHabitModal from './components/NewHabitModal';
import EditHabitModal from './components/EditHabitModal';
import Calendar from './components/Calendar';
import HabitsView from './components/HabitsView';
import ProgressDashboard from './components/ProgressDashboard';
import Login from './components/Login';
import EditProfile from './components/EditProfile';
import { habitsData as initialHabitsData } from './data/habitsData';
import * as api from './services/api';
import * as localStorageService from './services/localStorage';

// üîß Funci√≥n helper para normalizar nombres de d√≠as
// Convierte abreviaturas ('lun', 'mar') a nombres completos ('Lunes', 'Martes')
const normalizeDayName = (day) => {
  const dayMap = {
    'dom': 'Domingo',
    'lun': 'Lunes',
    'mar': 'Martes',
    'mie': 'Miercoles',
    'jue': 'Jueves',
    'vie': 'Viernes',
    'sab': 'Sabado',
    // Tambi√©n aceptar nombres completos (por si acaso)
    'Domingo': 'Domingo',
    'Lunes': 'Lunes',
    'Martes': 'Martes',
    'Miercoles': 'Miercoles',
    'Jueves': 'Jueves',
    'Viernes': 'Viernes',
    'Sabado': 'Sabado'
  };
  return dayMap[day] || day;
};

// Componente simple de Toast
function ToastContainer() {
  const [toasts, setToasts] = useState([]);

  useEffect(() => {
    const handleShowToast = (event) => {
      const id = Date.now();
      const newToast = { id, message: event.detail.message };
      setToasts(prev => [...prev, newToast]);
      
      setTimeout(() => {
        setToasts(prev => prev.filter(toast => toast.id !== id));
      }, 3000);
    };

    window.addEventListener('showToast', handleShowToast);
    return () => window.removeEventListener('showToast', handleShowToast);
  }, []);

  return (
    <div className="fixed top-20 right-4 z-50 space-y-2">
      {toasts.map(toast => (
        <div
          key={toast.id}
          className="bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-in slide-in-from-right"
        >
          <span className="material-icons">check_circle</span>
          <span>{toast.message}</span>
        </div>
      ))}
    </div>
  );
}

function App() {
  // Estado de autenticaci√≥n
  const [usuario, setUsuario] = useState(null);
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [darkMode, setDarkMode] = useState(false);
  const [currentView, setCurrentView] = useState('today'); // 'today', 'calendar', 'habits', 'analytics'
  const [showNewHabitModal, setShowNewHabitModal] = useState(false);
  const [showEditHabitModal, setShowEditHabitModal] = useState(false);
  const [showEditProfileModal, setShowEditProfileModal] = useState(false);
  const [currentEditHabit, setCurrentEditHabit] = useState(null);
  const [habitsData, setHabitsData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [completedHabits, setCompletedHabits] = useState(() => {
    return localStorageService.getCompletedHabits();
  });

  // Funci√≥n auxiliar para obtener el ID del usuario actual
  const getUserId = () => {
    return usuario?.id || usuario?._id || null;
  };

  // Verificar si hay usuario guardado en localStorage al cargar
  useEffect(() => {
    const savedUser = localStorage.getItem('usuario');
    if (savedUser) {
      try {
        const parsedUser = JSON.parse(savedUser);
        setUsuario(parsedUser);
        setIsAuthenticated(true);
      } catch (error) {
        console.error('Error al parsear usuario:', error);
        localStorage.removeItem('usuario');
      }
    }
  }, []);

  // Cargar h√°bitos del backend al iniciar (solo si est√° autenticado)
  useEffect(() => {
    if (isAuthenticated && usuario) {
      loadHabitsFromBackend();
    }
  }, [isAuthenticated, usuario]);

  // Funci√≥n para cargar h√°bitos del backend
  const loadHabitsFromBackend = async () => {
    try {
      setLoading(true);
      
      // Obtener el ID del usuario
      const userId = usuario?.id || usuario?._id;
      
      if (!userId) {
        console.error('‚ùå No se encontr√≥ el ID del usuario');
        setHabitsData([]);
        setLoading(false);
        return;
      }
      
      console.log('üîç Cargando h√°bitos para el usuario:', userId);
      
      // Obtener solo los h√°bitos del usuario actual
      const backendHabits = await api.getHabitos({ usuarioId: userId });
      
      console.log(`‚úÖ Se encontraron ${backendHabits.length} h√°bitos del usuario`);
      
      // Mapear h√°bitos del backend al formato frontend
      const mappedHabits = backendHabits.map(habit => 
        api.mapHabitoToFrontend(habit)
      );
      
      setHabitsData(mappedHabits);
    } catch (error) {
      console.error('Error al cargar h√°bitos:', error);
      setHabitsData([]);
      showErrorMessage('No se pudieron cargar los h√°bitos. Verifica que el servidor est√© corriendo en http://localhost:8000');
    } finally {
      setLoading(false);
    }
  };

  // Cargar tema guardado
  useEffect(() => {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
      setDarkMode(true);
      document.documentElement.classList.add('dark');
    }
  }, []);

  // üÜï Efecto para inicializar registros del d√≠a autom√°ticamente
  useEffect(() => {
    const initializeDailyRecords = async () => {
      if (habitsData.length === 0) return; // Esperar a que carguen los h√°bitos
      
      const today = getCurrentDateString();
      const currentDay = getDayOfWeek(new Date());
      
      // Obtener h√°bitos que aplican para hoy (misma l√≥gica que habitAppliesToToday)
      const todayHabitsToInit = habitsData.filter(habit => {
        const frequency = (habit.frequency || '').toLowerCase();
        
        if (frequency === 'diario' || frequency === 'diaria') {
          return true;
        } else if (frequency === 'semanal') {
          // Verificar que el h√°bito tenga d√≠as configurados y que hoy est√© incluido
          if (!habit.days || habit.days.length === 0) {
            return false;
          }
          // üîß NORMALIZAR LOS D√çAS: Convertir 'lun' -> 'Lunes', etc.
          const normalizedHabitDays = habit.days.map(day => normalizeDayName(day));
          return normalizedHabitDays.includes(currentDay);
        } else if (frequency === 'mensual') {
          // Los h√°bitos mensuales se muestran todos los d√≠as del mes
          // La l√≥gica de "ya completado" se maneja despu√©s al consultar el backend
          return true;
        }
        return false;
      });
      
      console.log(`üìÖ Inicializando registros para ${today}...`);
      console.log(`üìã H√°bitos del d√≠a: ${todayHabitsToInit.length}`);
      
      // Para cada h√°bito del d√≠a, verificar si ya tiene registro
      for (const habit of todayHabitsToInit) {
        const alreadyCompleted = completedHabits[today]?.includes(habit.id) || false;
        
        // Verificar si el h√°bito ya tiene registro en el backend
        try {
          const registros = await api.getRegistros(habit.id);
          const registroHoy = registros.find(r => r.fecha === today);
          
          if (!registroHoy) {
            // No existe registro, crear uno en false
            console.log(`‚ûï Creando registro en false para: ${habit.name}`);
            await api.toggleHabitoCompletado(habit.id, today, false);
          } else {
            console.log(`‚úì Registro ya existe para: ${habit.name} (estado: ${registroHoy.estado})`);
            
            // Sincronizar con localStorage si el backend tiene el registro en true
            if (registroHoy.estado && !alreadyCompleted) {
              const newCompletedHabits = localStorageService.toggleHabitCompletion(habit.id, today, true);
              setCompletedHabits(newCompletedHabits);
            }
          }
        } catch (error) {
          console.error(`Error al verificar registro de ${habit.name}:`, error);
        }
      }
    };
    
    // Ejecutar solo cuando cambien los h√°bitos
    initializeDailyRecords();
  }, [habitsData]); // Solo cuando cambian los h√°bitos

  // Toggle dark mode
  const toggleDarkMode = () => {
    setDarkMode(!darkMode);
    if (!darkMode) {
      document.documentElement.classList.add('dark');
      localStorage.setItem('theme', 'dark');
    } else {
      document.documentElement.classList.remove('dark');
      localStorage.setItem('theme', 'light');
    }
  };

  // Manejar login exitoso
  const handleLoginSuccess = (userData) => {
    setUsuario(userData);
    setIsAuthenticated(true);
    console.log('‚úÖ Usuario autenticado:', userData);
  };

  // Manejar logout
  const handleLogout = () => {
    setUsuario(null);
    setIsAuthenticated(false);
    localStorage.removeItem('usuario');
    setHabitsData([]);
    setCompletedHabits({});
    setCurrentView('today');
    console.log('üëã Sesi√≥n cerrada');
  };

  // Manejar actualizaci√≥n de perfil
  const handleUpdateProfile = (updatedUser) => {
    setUsuario(updatedUser);
    console.log('‚úÖ Perfil actualizado:', updatedUser);
    // Mostrar mensaje de √©xito
    showSuccessMessage('Perfil actualizado correctamente');
  };

  // Funciones para obtener d√≠a y fecha
  const getDayOfWeek = (date = new Date()) => {
    const days = ['Domingo', 'Lunes', 'Martes', 'Miercoles', 'Jueves', 'Viernes', 'Sabado'];
    return days[date.getDay()];
  };

  const getCurrentDateString = () => {
    const today = new Date();
    return today.toISOString().split('T')[0];
  };

  // Verificar si un h√°bito aplica al d√≠a actual
  const habitAppliesToToday = (habit) => {
    const today = new Date();
    const currentDay = getDayOfWeek(today);
    const todayStr = getCurrentDateString();
    
    // Convertir a min√∫sculas para comparaci√≥n
    const frequency = (habit.frequency || '').toLowerCase();
    
    if (frequency === 'diario' || frequency === 'diaria') {
      return true;
    } else if (frequency === 'semanal') {
      // Verificar que el h√°bito tenga d√≠as configurados y que hoy est√© incluido
      if (!habit.days || habit.days.length === 0) {
        console.warn(`‚ö†Ô∏è H√°bito semanal "${habit.name}" no tiene d√≠as configurados`);
        return false;
      }
      
      // üîß NORMALIZAR LOS D√çAS: Convertir 'lun' -> 'Lunes', etc.
      const normalizedHabitDays = habit.days.map(day => normalizeDayName(day));
      const applies = normalizedHabitDays.includes(currentDay);
      
      console.log(`üìÖ H√°bito "${habit.name}"`);
      console.log(`   D√≠as originales: [${habit.days.join(', ')}]`);
      console.log(`   D√≠as normalizados: [${normalizedHabitDays.join(', ')}]`);
      console.log(`   Hoy: ${currentDay}`);
      console.log(`   Aplica: ${applies}`);
      
      return applies;
    } else if (frequency === 'mensual') {
      // üîß H√ÅBITOS MENSUALES: Se muestran todos los d√≠as del mes hasta que se completen
      // Una vez completado en CUALQUIER d√≠a del mes, no se vuelven a mostrar en ese mes
      
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      // Verificar si ya se complet√≥ en alg√∫n d√≠a de este mes
      let completadoEsteMes = false;
      
      for (const dateStr in completedHabits) {
        if (completedHabits[dateStr]?.includes(habit.id)) {
          // Parsear la fecha del registro completado
          const [year, month, day] = dateStr.split('-').map(Number);
          const completedDate = new Date(year, month - 1, day);
          
          // Verificar si es del mismo mes y a√±o
          if (completedDate.getMonth() === currentMonth && 
              completedDate.getFullYear() === currentYear) {
            // Verificar si fue completado en un d√≠a ANTERIOR a hoy
            const todayDateOnly = new Date(currentYear, currentMonth, today.getDate());
            const completedDateOnly = new Date(year, month - 1, day);
            
            if (completedDateOnly < todayDateOnly) {
              // Fue completado en un d√≠a anterior de este mes
              completadoEsteMes = true;
              break;
            }
          }
        }
      }
      
      // Si ya se complet√≥ en un d√≠a anterior de este mes, no mostrarlo
      if (completadoEsteMes) {
        return false;
      }
      
      // Si no se ha completado o se complet√≥ hoy, mostrarlo
      return true;
    }
    return false;
  };

  // Verificar si un h√°bito est√° completado hoy
  const isHabitCompletedToday = (habitId) => {
    const dateStr = getCurrentDateString();
    return completedHabits[dateStr]?.includes(habitId) || false;
  };

  // Toggle completar h√°bito
  const toggleHabitCompletion = async (habitId, dateStr = null) => {
    const date = dateStr || getCurrentDateString();
    const wasCompleted = completedHabits[date]?.includes(habitId) || false;
    const newStatus = !wasCompleted;
    
    // Actualizar localStorage inmediatamente (optimistic update)
    const newCompletedHabits = localStorageService.toggleHabitCompletion(habitId, date, newStatus);
    setCompletedHabits(newCompletedHabits);
    
    // Sincronizar con backend usando el nuevo endpoint que previene duplicados
    try {
      await api.toggleHabitoCompletado(habitId, date, newStatus);
      showSuccessMessage(newStatus ? '¬°H√°bito completado! üéâ' : 'H√°bito desmarcado');
    } catch (error) {
      console.error('Error al sincronizar con backend:', error);
      // Revertir el cambio en localStorage si falla
      const revertedHabits = localStorageService.toggleHabitCompletion(habitId, date, wasCompleted);
      setCompletedHabits(revertedHabits);
      showErrorMessage('Error al guardar. Intenta de nuevo.');
    }
  };

  // Obtener h√°bitos del d√≠a
  const todayHabits = habitsData.filter(habit => habitAppliesToToday(habit));

  // Manejar creaci√≥n de nuevo h√°bito
  const handleCreateHabit = async (newHabitData) => {
    try {
      const userId = getUserId();
      
      if (!userId) {
        showErrorMessage('No se pudo identificar el usuario. Por favor, inicia sesi√≥n nuevamente.');
        return;
      }
      
      // ‚ú® Mapear al formato del backend (INCLUYE icon y color)
      const backendData = api.mapHabitoToBackend(newHabitData, userId);
      
      // Crear en el backend
      const createdHabit = await api.createHabito(backendData);
      
      // ‚ú® Mapear de vuelta al frontend (icon y color ya vienen del backend)
      const frontendHabit = api.mapHabitoToFrontend(createdHabit);
      setHabitsData([...habitsData, frontendHabit]);
      
      setShowNewHabitModal(false);
      showSuccessMessage('¬°H√°bito creado exitosamente!');
    } catch (error) {
      console.error('Error al crear h√°bito:', error);
      showErrorMessage('Error al crear el h√°bito. Intenta de nuevo.');
    }
  };

  // Manejar edici√≥n de h√°bito
  const handleEditHabit = async (editedHabitData) => {
    try {
      const userId = getUserId();
      
      if (!userId) {
        showErrorMessage('No se pudo identificar el usuario. Por favor, inicia sesi√≥n nuevamente.');
        return;
      }
      
      // ‚ú® Mapear al formato del backend (INCLUYE icon y color)
      const backendData = api.mapHabitoToBackend(editedHabitData, userId);
      
      // Actualizar en el backend
      const updatedHabit = await api.updateHabito(editedHabitData.id, backendData);
      
      // ‚ú® Actualizar en el estado local (icon y color vienen del backend)
      const frontendHabit = api.mapHabitoToFrontend(updatedHabit);
      const updatedHabits = habitsData.map(habit =>
        habit.id === editedHabitData.id ? frontendHabit : habit
      );
      setHabitsData(updatedHabits);
      
      setShowEditHabitModal(false);
      setCurrentEditHabit(null);
      showSuccessMessage('¬°H√°bito actualizado exitosamente!');
    } catch (error) {
      console.error('Error al actualizar h√°bito:', error);
      showErrorMessage('Error al actualizar el h√°bito. Intenta de nuevo.');
    }
  };

  // Manejar eliminaci√≥n de h√°bito
  const handleDeleteHabit = async (habitId) => {
    if (window.confirm('¬øEst√°s seguro de que quieres eliminar este h√°bito?')) {
      try {
        // Eliminar del backend
        await api.deleteHabito(habitId);
        
        // ‚ú® YA NO necesitamos eliminar de localStorage (icon y color est√°n en backend)
        
        // Actualizar estado local
        const updatedHabits = habitsData.filter(habit => habit.id !== habitId);
        setHabitsData(updatedHabits);
        
        setShowEditHabitModal(false);
        setCurrentEditHabit(null);
        showSuccessMessage('H√°bito eliminado exitosamente');
      } catch (error) {
        console.error('Error al eliminar h√°bito:', error);
        showErrorMessage('Error al eliminar el h√°bito. Intenta de nuevo.');
      }
    }
  };

  // Abrir modal de edici√≥n
  const openEditModal = (habit) => {
    setCurrentEditHabit(habit);
    setShowEditHabitModal(true);
  };

  // Mostrar mensaje de √©xito
  const showSuccessMessage = (message) => {
    const event = new CustomEvent('showToast', { detail: { message } });
    window.dispatchEvent(event);
  };

  // Mostrar mensaje de error
  const showErrorMessage = (message) => {
    const event = new CustomEvent('showToast', { detail: { message } });
    window.dispatchEvent(event);
  };

  return (
    <div className="relative w-full min-h-screen bg-background-light dark:bg-background-dark font-display">
      {/* Mostrar Login si no est√° autenticado */}
      {!isAuthenticated ? (
        <Login onLoginSuccess={handleLoginSuccess} />
      ) : (
        <>
          {/* Indicador de carga */}
          {loading && (
            <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
              <div className="bg-card-light dark:bg-card-dark rounded-lg p-8 flex flex-col items-center gap-4">
                <div className="animate-spin rounded-full h-12 w-12 border-4 border-primary border-t-transparent"></div>
                <p className="text-text-light dark:text-text-dark font-semibold">Cargando h√°bitos...</p>
              </div>
            </div>
          )}
          
          {/* Sidebar */}
          <Sidebar 
            isOpen={sidebarOpen}
            onClose={() => setSidebarOpen(false)}
            darkMode={darkMode}
            onToggleDarkMode={toggleDarkMode}
            onLogout={handleLogout}
            usuario={usuario}
            onEditProfile={() => setShowEditProfileModal(true)}
          />

          {/* Overlay para m√≥vil */}
          {sidebarOpen && (
            <div 
              className="fixed inset-0 bg-black bg-opacity-50 z-20 lg:hidden"
              onClick={() => setSidebarOpen(false)}
            />
          )}

      {/* Modal para crear nuevo h√°bito */}
      <NewHabitModal
        isOpen={showNewHabitModal}
        onClose={() => setShowNewHabitModal(false)}
        onSubmit={handleCreateHabit}
      />

      {/* Modal para editar h√°bito */}
      {currentEditHabit && (
        <EditHabitModal
          isOpen={showEditHabitModal}
          onClose={() => {
            setShowEditHabitModal(false);
            setCurrentEditHabit(null);
          }}
          onSubmit={handleEditHabit}
          onDelete={handleDeleteHabit}
          habitData={currentEditHabit}
        />
      )}

      {/* Modal para editar perfil */}
      <EditProfile
        isOpen={showEditProfileModal}
        onClose={() => setShowEditProfileModal(false)}
        usuario={usuario}
        onUpdateSuccess={handleUpdateProfile}
      />

      {/* Main Content */}
      <div className="lg:ml-64 transition-all duration-300 ease-in-out min-h-screen">
        {/* Header fijo con t√≠tulo de secci√≥n */}
        <header className="sticky top-0 z-20 bg-background-light dark:bg-background-dark border-b border-gray-200 dark:border-gray-700">
          <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 sm:py-4">
            <div className="flex justify-between items-center">
              <div className="flex items-center gap-3">
                <button 
                  className="relative p-2 lg:hidden hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors"
                  onClick={() => setSidebarOpen(true)}
                >
                  <span className="material-icons text-text-light dark:text-text-dark">menu</span>
                  <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-primary rounded-full border-2 border-background-light dark:border-background-dark"></span>
                </button>
                <h1 className="text-xl sm:text-2xl lg:text-3xl font-bold text-text-light dark:text-text-dark">
                  {currentView === 'today' && 'H√°bitos del d√≠a'}
                  {currentView === 'calendar' && 'Calendario'}
                  {currentView === 'habits' && 'Todos mis h√°bitos'}
                  {currentView === 'analytics' && 'Dashboard de Progreso'}
                </h1>
              </div>
            </div>
          </div>
        </header>

        {/* Contenido principal con padding para header y footer */}
        <main className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 pb-40 sm:pb-36 lg:pb-16">
          <div>
            {currentView === 'today' && (
              <div>
                {/* Grid de h√°bitos */}
                <div className="habits-grid mb-8">
                  {todayHabits.length === 0 ? (
                    <div className="col-span-full text-center py-12">
                      <span className="material-icons text-6xl text-subtext-light dark:text-subtext-dark mb-4">event_available</span>
                      <p className="text-xl text-subtext-light dark:text-subtext-dark">No hay h√°bitos para hoy</p>
                      <p className="text-sm text-subtext-light dark:text-subtext-dark mt-2">¬°Disfruta tu d√≠a libre!</p>
                    </div>
                  ) : (
                    todayHabits.map(habit => (
                      <HabitCard
                        key={habit.id}
                        habit={habit}
                        isCompleted={isHabitCompletedToday(habit.id)}
                        onComplete={toggleHabitCompletion}
                        onEdit={openEditModal}
                        showCompleteButton={true}
                      />
                    ))
                  )}
                </div>
              </div>
            )}

            {currentView === 'calendar' && (
              <Calendar 
                habitsData={habitsData}
                completedHabits={completedHabits}
              />
            )}

            {currentView === 'habits' && (
              <HabitsView 
                habits={habitsData}
                onEditHabit={openEditModal}
                onDeleteHabit={handleDeleteHabit}
              />
            )}

            {currentView === 'analytics' && (
              <ProgressDashboard habitos={habitsData} />
            )}
          </div>
        </main>

        {/* Footer Navigation */}
        <Footer 
          onAddHabit={() => setShowNewHabitModal(true)}
          currentView={currentView}
          onChangeView={setCurrentView}
        />
      </div>

      {/* Toast Container */}
      <ToastContainer />
      </>
      )}
    </div>
  );
}

export default App;
